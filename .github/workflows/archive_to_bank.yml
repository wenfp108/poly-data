name: ğŸ¦ Central Bank Harvest & Cleanup

on:
  workflow_run:
    workflows: ["âš”ï¸ PolyData Dual-Engine System"] # å¿…é¡»å®Œå…¨åŒ¹é…ä¸Šæ¸¸ Workflow çš„ name
    types:
      - completed

jobs:
  harvest:
    # åªæœ‰å½“æŠ“å–æ•°æ®æˆåŠŸæ—¶æ‰æ‰§è¡Œæ”¶å‰²é€»è¾‘ï¼Œä½“ç°é˜²å¾¡å‹æŠ•èµ„è€…çš„ä¸¥è°¨
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Scraper Repo (Current)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }} # éœ€è¦æƒé™æ¥æ¨é€åˆ é™¤æ“ä½œ

      - name: Checkout Central Bank (Vault)
        uses: actions/checkout@v4
        with:
          repository: wenfp108/Central-Bank
          token: ${{ secrets.MY_PAT }}
          path: central_bank

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¦ Execute Archive & Local Delete
        run: |
          # è¿è¡Œä½ å·²æœ‰çš„è„šæœ¬ï¼Œå®ƒä¼šæ‰§è¡Œ copy å¹¶ unlink æ‰æœ¬åœ°æ–‡ä»¶
          node scripts/archive-poly-to-bank.js
          
      - name: ğŸ“¤ Push to Central Bank
        run: |
          cd central_bank
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add .
          git commit -m "Vault Update: archive polymarket data $(date +%F)" || exit 0
          git push

      - name: ğŸ§¹ Cleanup Scraper Repo
        run: |
          # è„šæœ¬æ‰§è¡Œå®Œåï¼Œdata/ ç›®å½•ä¸‹çš„ä»Šæ—¥æ–‡ä»¶å·²è¢« unlink
          # è¿™é‡Œå°†è¿™äº›â€œåˆ é™¤â€æ“ä½œæ¨é€åˆ°å½“å‰ä»“åº“ï¼Œä¿æŒä»“åº“è½»é‡
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add data/
          git commit -m "System: Data harvested and moved to Central Bank $(date +%F)" || exit 0
          git push
